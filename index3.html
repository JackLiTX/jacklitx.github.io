<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webcam Object Detector — Teachable Machine + TensorFlow.js</title>
  <meta name="description" content="Detect hand, cream, and phone with a Teachable Machine model using your webcam in the browser via TensorFlow.js." />
  <style>
    :root{
      --bg:#0b1020; --panel:#111831; --text:#eaf0ff; --muted:#9fb0ff; --accent:#6aa5ff; --ok:#34d399; --danger:#f87171;
      --radius:16px; --shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fbff; --panel:#fff; --text:#0f172a; --muted:#475569; --shadow:0 10px 22px rgba(15,23,42,.08)}
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; color:var(--text); background:var(--bg)}
    a{color:var(--accent)}
    .container{max-width:1100px; margin:auto; padding: clamp(16px, 3vw, 32px)}
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid color-mix(in srgb, var(--text) 12%, transparent); background:color-mix(in srgb, var(--bg) 80%, transparent)}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; color:var(--text); text-decoration:none}
    .brand-logo{width:38px; height:38px; border-radius:12px; background:linear-gradient(135deg, var(--accent), #9ef0c0); display:grid; place-items:center; color:#071023; font-weight:900; box-shadow:var(--shadow)}
    .card{background:var(--panel); border:1px solid color-mix(in srgb, var(--text) 10%, transparent); border-radius:var(--radius); box-shadow:var(--shadow)}
    .pad{padding:clamp(14px,2.4vw,24px)}
    .grid{display:grid; gap:18px}
    .grid.two{grid-template-columns:1.05fr .95fr}
    @media (max-width:960px){ .grid.two{grid-template-columns:1fr} }
    h1{margin:0 0 6px; font-size: clamp(26px, 2.4vw + 10px, 42px)}
    h2{margin:0 0 10px; font-size: clamp(20px, 1.5vw + 8px, 28px)}
    .lead{color:var(--muted)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} }
    label{font-weight:700}
    input[type="text"], select{width:100%; padding:12px 14px; border-radius:12px; border:1px solid color-mix(in srgb, var(--text) 18%, transparent); background:transparent; color:var(--text); font:inherit}
    .btn{appearance:none; border:none; border-radius:999px; padding:10px 16px; font-weight:800; cursor:pointer; color:#071023; background:var(--accent); box-shadow:var(--shadow)}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid color-mix(in srgb, var(--text) 20%, transparent)}
    .btn.warn{background:var(--danger); color:#fff}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .status{font-weight:700; font-size:14px; padding:6px 10px; border-radius:10px; display:inline-block}
    .status.ok{background:color-mix(in srgb, var(--ok) 18%, transparent); color:#065f46; border:1px solid color-mix(in srgb, var(--ok) 35%, transparent)}
    .status.err{background:color-mix(in srgb, var(--danger) 16%, transparent); color:#5b1020; border:1px solid color-mix(in srgb, var(--danger) 28%, transparent)}

    /* Video panel */
    .stage{display:grid; grid-template-columns:1fr; place-items:center; background:#000; border-radius:14px; overflow:hidden; position:relative}
    canvas{width:100%; height:auto; display:block; background:#000}
    .badge{position:absolute; top:10px; left:10px; background:rgba(0,0,0,.45); color:#fff; padding:6px 10px; border-radius:999px; font-weight:800}
    .detected{position:absolute; bottom:10px; left:10px; right:10px; display:flex; justify-content:space-between; gap:10px; align-items:center}
    .detected .label{font-weight:900; font-size: clamp(18px, 2vw + 6px, 28px)}
    .detected .score{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    /* Prediction list */
    .preds{display:grid; gap:10px}
    .pred{
      display:grid; gap:6px; background:color-mix(in srgb, var(--text) 4%, transparent);
      border:1px solid color-mix(in srgb, var(--text) 12%, transparent);
      padding:10px; border-radius:12px
    }
    .bar{height:10px; border-radius:10px; background:color-mix(in srgb, var(--text) 12%, transparent); overflow:hidden}
    .bar > span{display:block; height:100%; width:0%}

    footer{margin-top:18px; color:var(--muted); text-align:center}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,1,1); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="#top" aria-label="Home">
        <span class="brand-logo" aria-hidden="true">AI</span>
        <div>
          <strong>Webcam Detector</strong><br>
          <small class="lead">Teachable Machine × TensorFlow.js</small>
        </div>
      </a>
    </div>
  </header>

  <main id="top" class="container">
    <div class="grid two">
      <section class="card pad" aria-labelledby="setup-h">
        <h1 id="setup-h">Detect hand, cream, and phone — live in your browser</h1>
        <p class="lead">Paste your Teachable Machine model URL, start the camera, and see predictions update in real‑time. Works best over HTTPS and on modern browsers.</p>

        <div class="row" style="margin-top:10px">
          <div>
            <label for="cameraSelect">Camera</label>
            <select id="cameraSelect"></select>
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button class="btn" id="startBtn" disabled>Start Camera</button>
          <button class="btn ghost" id="stopBtn" disabled>Stop</button>
          <button class="btn ghost" id="flipBtn" disabled>Flip</button>
          <span id="status" class="status" aria-live="polite"></span>
        </div>

        <div class="card pad" style="margin-top:14px">
          <h2>How it works</h2>
          <ol>
            <li>Export your Teachable Machine model to <em>TensorFlow.js</em> and download it.</li>
            <li>Put the downloaded folder as <code>my_model/</code> next to this HTML file (it must include <code>model.json</code> and <code>metadata.json</code>).</li>
            <li>Serve this page from a local web server (e.g., <code>python -m http.server</code>) to satisfy browser security/CORS.</li>
            <li>When the page loads, the model is loaded automatically. Choose a camera and click <strong>Start Camera</strong>.</li>
          </ol>
        </div>
      </section>

      <section class="card pad" aria-labelledby="live-h">
        <h2 id="live-h">Live View</h2>
        <div class="stage">
          <span class="badge" id="fps">0 fps</span>
          <canvas id="canvas" width="640" height="480" aria-label="Webcam preview"></canvas>
          <div class="detected">
            <div class="label" id="topLabel">—</div>
            <div class="score" id="topScore">0.00</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <h3>Class probabilities</h3>
          <div id="predictions" class="preds" aria-live="polite"></div>
        </div>
      </section>
    </div>

    <footer>Built for Teachable Machine models • Works offline after first load</footer>
  </main>

  <!-- TensorFlow.js & Teachable Machine helper -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    // DOM helpers
    const $ = (s, r=document) => r.querySelector(s);
    const $all = (s, r=document) => [...r.querySelectorAll(s)];

    const canvas = $('#canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const predsEl = $('#predictions');
    const statusEl = $('#status');
    const fpsEl = $('#fps');
    const cameraSelect = $('#cameraSelect');
    const topLabelEl = $('#topLabel');
    const topScoreEl = $('#topScore');

    let model, maxPredictions = 0;
    let webcam; // tmImage.Webcam
    let running = false, rafId = null;
    let smooth = []; // EMA for stability
    const ALPHA = 0.35; // smoothing factor

    // Populate cameras
    async function listCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videos = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = '';
        videos.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Camera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
      }catch(err){ /* ignore until permission granted */ }
    }
    if (navigator.mediaDevices?.enumerateDevices) listCameras();

    // Load model from TM share URL
    async function loadModel(){
      try{
        setStatus('Loading model…');
        const modelURL = 'my_model/model.json';
        const metadataURL = 'my_model/metadata.json';
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        smooth = Array(maxPredictions).fill(0);
        renderPredictionList(model.getClassLabels());
        $('#startBtn').disabled = false;
        setStatus(`Model loaded (${maxPredictions} classes).`, false, true);
      }catch(err){
        console.error(err);
        setStatus('Failed to load local model from ./my_model/. Make sure files are being served over HTTP(s).', true);
      }
    }
      const fixed = base.endsWith('/') ? base : base + '/';
      const modelURL = fixed + 'model.json';
      const metadataURL = fixed + 'metadata.json';
      try{
        setStatus('Loading model…');
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        smooth = Array(maxPredictions).fill(0);
        renderPredictionList(model.getClassLabels());
        $('#startBtn').disabled = false;
        setStatus(`Model loaded (${maxPredictions} classes).`, false, true);
      }catch(err){
        console.error(err);
        setStatus('Failed to load model. Check the URL and CORS/hosting.', true);
      }
    }

    // Render class list UI
    function renderPredictionList(labels){
      predsEl.innerHTML = '';
      labels.forEach(label => {
        const row = document.createElement('div');
        row.className = 'pred';
        row.innerHTML = `<div><strong>${escapeHtml(label)}</strong> <span class="val" style="float:right">0.00</span></div>
                         <div class="bar"><span></span></div>`;
        predsEl.appendChild(row);
      });
    }

    // Start webcam and loop
    async function start(){
      if(!model){ return setStatus('Model is still loading… please try again in a moment.', true); }
      const deviceId = cameraSelect.value || undefined;
      const flip = shouldMirror();
      try{
        $('#startBtn').disabled = true;
        setStatus('Starting camera…');
        webcam = new tmImage.Webcam(640, 480, flip); // width, height, flip
        await webcam.setup(deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' });
        await webcam.play();
        // After permission we can get device labels
        await listCameras();
        running = true;
        $('#stopBtn').disabled = false;
        $('#flipBtn').disabled = false;
        loop();
        setStatus('Live', false, true);
      }catch(err){
        console.error(err);
        setStatus('Camera failed to start. Check permissions and HTTPS.', true);
        $('#startBtn').disabled = false;
      }
    }

    function stop(){
      running = false;
      if (rafId) cancelAnimationFrame(rafId);
      if (webcam){ webcam.stop(); webcam = null; }
      ctx.clearRect(0,0,canvas.width, canvas.height);
      setStatus('Stopped');
      $('#startBtn').disabled = false;
      $('#stopBtn').disabled = true;
    }

    function flip(){
      if(!webcam) return;
      webcam.flip();
    }

    function shouldMirror(){
      // Mirror front camera for a natural selfie view; back camera not mirrored.
      const selectedLabel = cameraSelect.options[cameraSelect.selectedIndex]?.textContent || '';
      const frontish = /front|user|facetime/i.test(selectedLabel);
      return frontish;
    }

    // Main loop
    let lastTime = performance.now();
    async function loop(){
      if(!running || !webcam) return;
      webcam.update();
      // draw to canvas
      ctx.drawImage(webcam.canvas, 0, 0, canvas.width, canvas.height);

      // predict
      const preds = await model.predict(webcam.canvas);
      updateUI(preds);

      // FPS
      const now = performance.now();
      const fps = 1000 / (now - lastTime); lastTime = now;
      fpsEl.textContent = `${fps.toFixed(0)} fps`;

      rafId = requestAnimationFrame(loop);
    }

    function updateUI(preds){
      // Sort by probability desc
      const arr = preds.map(p => ({ label: p.className, p: p.probability }));
      arr.sort((a,b)=> b.p - a.p);

      // Smooth probabilities by class order of metadata
      const classLabels = model.getClassLabels();
      classLabels.forEach((label, i) => {
        const found = arr.find(a => a.label === label)?.p ?? 0;
        smooth[i] = ALPHA * found + (1-ALPHA) * smooth[i];
      });

      // Update bars & numbers
      const rows = $all('#predictions .pred');
      classLabels.forEach((label, i) => {
        const row = rows[i];
        const valEl = row.querySelector('.val');
        const bar = row.querySelector('.bar > span');
        const pct = (smooth[i] * 100);
        valEl.textContent = pct.toFixed(2) + '%';
        bar.style.width = Math.max(2, pct) + '%';
        bar.style.background = pct > 75 ? 'linear-gradient(90deg, #34d399, #6aa5ff)' : pct > 40 ? '#6aa5ff' : 'color-mix(in srgb, var(--text) 22%, transparent)';
      });

      // Top label
      const top = arr[0] || { label: '—', p: 0 };
      topLabelEl.textContent = top.label;
      topScoreEl.textContent = (top.p * 100).toFixed(2) + '%';
    }

    // Utilities
    function setStatus(msg, isErr=false, isOk=false){
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (isErr ? 'err' : (isOk ? 'ok' : ''));
    }
    function escapeHtml(s){
      return s.replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // Page visibility — pause when hidden to save battery
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stop(); });

    // Wire up controls
    window.addEventListener('DOMContentLoaded', loadModel);
    $('#startBtn').addEventListener('click', start);
    $('#stopBtn').addEventListener('click', stop);
    $('#flipBtn').addEventListener('click', flip);

    // Sensible defaults for demo/testing
    // If you want, set a default model URL here:
    // $('#modelUrl').value = 'https://teachablemachine.withgoogle.com/models/XXXXXXXXX/';
  </script>
</body>
</html>
